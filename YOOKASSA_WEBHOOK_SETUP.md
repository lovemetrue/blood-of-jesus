# Настройка Webhook для ЮKassa

## Описание

Этот документ содержит инструкции по настройке webhook для получения уведомлений от ЮKassa о статусе платежей.

## URL Webhook

```
https://bloodofjesus.ru/api/yokassa_webhook
```

## События для подписки

В личном кабинете ЮKassa необходимо подписаться на следующие события:

1. **payment.succeeded** - успешная оплата
   - Срабатывает когда платеж успешно завершен
   - Обновляет статус пожертвования на `completed`
   - Отправляет email благодарности плательщику (если указан email)

2. **payment.canceled** - отмена платежа
   - Срабатывает когда платеж отменен
   - Обновляет статус пожертвования на `canceled`

## Инструкция по настройке в личном кабинете ЮKassa

1. Войдите в [личный кабинет ЮKassa](https://yookassa.ru/my)

2. Перейдите в раздел **"Настройки"** → **"Уведомления"** (или **"Webhooks"**)

3. Нажмите **"Добавить webhook"** или **"Создать webhook"**

4. Заполните форму:
   - **URL**: `https://bloodofjesus.ru/api/yokassa_webhook`
   - **События**: Выберите следующие события:
     - ✅ `payment.succeeded`
     - ✅ `payment.canceled`

5. Сохраните настройки

6. ЮKassa отправит тестовый запрос для проверки работоспособности webhook

## Проверка работоспособности

После настройки webhook можно проверить его работу:

1. Создайте тестовое пожертвование на сайте
2. Проверьте логи Django на наличие записей о получении webhook
3. Проверьте статус пожертвования в админ-панели Django

## Логирование

Все события webhook логируются в Django с уровнем INFO:
- Получение webhook запроса
- Обработка событий (succeeded, canceled)
- Ошибки обработки (если возникают)

Логи можно найти в стандартном выводе Django или в файлах логов (в зависимости от конфигурации).

## Безопасность

- Webhook endpoint защищен от CSRF атак (`@csrf_exempt` для POST запросов)
- Все запросы логируются для аудита
- Проверяется наличие обязательных полей в запросе
- Ошибки обрабатываются безопасно (возвращается 200 OK, чтобы ЮKassa не повторял запросы)

## Устранение проблем

### Webhook не получает уведомления

1. Проверьте, что URL указан правильно и доступен из интернета
2. Убедитесь, что сервер принимает HTTPS соединения
3. Проверьте настройки файрвола и прокси-сервера
4. Проверьте логи Django на наличие ошибок

### Ошибки обработки webhook

1. Проверьте логи Django для детальной информации об ошибке
2. Убедитесь, что база данных доступна и работает
3. Проверьте настройки email (если используется отправка уведомлений)
4. Убедитесь, что модель `Donation` существует и миграции применены

## Дополнительная информация

- Документация ЮKassa: https://yookassa.ru/developers/using-api/webhooks
- API Reference: https://yookassa.ru/developers/api#webhook
