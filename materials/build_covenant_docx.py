#!/usr/bin/env python3
"""
Создаёт 3 файла .docx в materials/Завет/ без внешних зависимостей:
копирует структуру heritage.docx и подставляет новый текст.
"""
import zipfile
import os
import shutil
import xml.sax.saxutils as sax

HERITAGE = os.path.join(os.path.dirname(__file__), "heritage.docx")
OUT_DIR = os.path.join(os.path.dirname(__file__), "Завет")
TEMPLATE_DIR = os.path.join(os.path.dirname(__file__), "_docx_template")

def esc(t):
    return sax.escape(t) if t else ""

def para(text):
    if not text.strip():
        return '<w:p><w:pPr><w:pStyle w:val="Normal"/><w:rPr></w:rPr></w:pPr><w:r><w:rPr></w:rPr></w:t></w:r></w:p>'
    return f'<w:p><w:pPr><w:pStyle w:val="Normal"/><w:rPr></w:rPr></w:pPr><w:r><w:rPr></w:rPr><w:t>{esc(text)}</w:t></w:r></w:p>'

def heading(text):
    return f'<w:p><w:pPr><w:pStyle w:val="Heading1"/><w:rPr></w:rPr></w:pPr><w:r><w:rPr><w:b/></w:rPr><w:t>{esc(text)}</w:t></w:r></w:p>'

def body(*paragraphs):
    inner = "".join(para(p) for p in paragraphs)
    return f'<w:body>{inner}<w:sectPr><w:pgSz w:w="12240" w:h="15840"/><w:pgMar w:left="1134" w:right="1134" w:top="1134" w:bottom="1134"/></w:sectPr></w:body>'

def make_document_xml(paragraphs):
    """Используем полную структуру document.xml из heritage — только заменяем тело. Так Word корректно открывает файл."""
    with zipfile.ZipFile(HERITAGE, "r") as z:
        doc = z.read("word/document.xml").decode("utf-8")
    new_body = body(*paragraphs)
    # Заменяем только содержимое между <w:body> и </w:body>
    doc = doc.replace(doc[doc.find("<w:body>") : doc.find("</w:body>") + len("</w:body>")], new_body)
    return doc

CONTENT = {
    "Спасения.docx": [
        "Завет спасения",
        "Наставление по заключению завета с Богом",
        "",
        "Бог — Бог заветов. Вся Библия говорит о Нём как о Том, Кто заключает заветы с людьми и хранит их. Он не просто даёт обетования — Он вступает в отношения завета со Своими детьми и очень ценит эти отношения.",
        "",
        "Почему завет спасения важен",
        "Завет спасения — это не только «принять Иисуса в сердце». Это осознанное вступление в отношения завета с Живым Богом: Он становится вашим Богом, вы — Его народом. В завете есть две стороны: Бог обязуется быть нашим Спасителем, Хранителем и Отцом; мы откликаемся верой, покаянием и посвящением Ему жизни.",
        "Иеремия 31:33 говорит о новом завете: «Вложу закон Мой во внутренность их и на сердцах их напишу его, и буду им Богом, а они будут Моим народом». Это и есть суть завета спасения: личные, вечные отношения с Богом.",
        "",
        "Как заключить завет спасения",
        "1. Признайте свою нужду в Спасителе и покайтесь в грехах.",
        "2. Уверуйте в Иисуса Христа: что Он умер за ваши грехи и воскрес, и что только через Него есть прощение и жизнь вечная.",
        "3. Откройте сердце Господу и примите Его как Господа и Спасителя — тем самым вы вступаете в завет с Ним.",
        "4. Провозгласите это вслух в молитве: попросите Бога быть вашим Богом и заявите о своём желании быть Его чадом по завету.",
        "",
        "Бог любит отношения завета. Заключив с Ним завет спасения, вы входите в ту самую близость, которую Он желает иметь с каждым из Своих детей.",
    ],
    "Посвящения.docx": [
        "Завет посвящения",
        "Наставление по заключению завета посвящения с Богом",
        "",
        "Бог — Бог заветов. Он не только спасает нас по завету благодати, но и призывает к завету посвящения: отдать Ему всю жизнь, сердце и волю. Он очень любит отношения завета со Своими детьми и ждёт от нас ответа — осознанного посвящения.",
        "",
        "Что такое завет посвящения",
        "Посвящение — это завет, в котором вы добровольно отдаёте себя Богу: «Господи, я больше не свой — я Твой». Это не «добавка» к спасению, а естественный отклик на милость Бога: «Итак умоляю вас, братия, милосердием Божиим, представьте тела ваши в жертву живую, святую, благоугодную Богу» (Римлянам 12:1).",
        "",
        "Как заключить завет посвящения",
        "1. Осознайте, что вы уже принадлежите Богу по завету спасения, и решите жить именно так — как Его.",
        "2. В молитве перед Богом откажитесь от права «распоряжаться собой» и передайте Ему свою жизнь, планы, семью, время и ресурсы.",
        "3. Попросите Святого Духа освящать вас и вести по путям святости и послушания Слову.",
        "4. Закрепите это молитвой завета: вслух объявите Богу о своём посвящении и попросите Его принять его и удержать вас в нём.",
        "",
        "Бог — Бог заветов и очень любит отношения завета со Своими детьми. Завет посвящения углубляет ваши отношения с Ним и открывает путь к благословенной жизни в послушании и святости.",
    ],
    "Даяния.docx": [
        "Завет даяния",
        "Наставление по заключению завета даяния с Богом (основано на Книге Малахии, 3 глава)",
        "",
        "Бог — Бог заветов. Он устанавливает не только завет спасения и посвящения, но и призывает Своих детей к завету даяния: к честному, радостному приношению десятины и приношений. Он очень любит отношения завета со Своими детьми и желает, чтобы мы не «обкрадывали» Его, а доверяли Ему своим имением.",
        "",
        "Слово Господа (Малахия 3:7–12)",
        "Со дней отцов ваших вы отступили от уставов Моих и не соблюдаете их; обратитесь ко Мне, и Я обращусь к вам, говорит Господь Саваоф. Вы скажете: «как нам обратиться?»",
        "Можно ли человеку обкрадывать Бога? А вы обкрадываете Меня. Скажете: «чем обкрадываем мы Тебя?» Десятиною и приношениями.",
        "Проклятием вы прокляты, потому что вы — весь народ — обкрадываете Меня.",
        "Принесите все десятины в дом хранилища, чтобы в доме Моём была пища, и хотя в этом испытайте Меня, говорит Господь Саваоф: не открою ли Я для вас отверстий небесных и не изолью ли на вас благословения до избытка?",
        "Я для вас запрещу пожирающим истреблять у вас плоды земные, и виноградная лоза на поле у вас не лишится плодов своих, говорит Господь Саваоф.",
        "И блаженными называть будут вас все народы, потому что вы будете землёю вожделенною, говорит Господь Саваоф.",
        "",
        "Важность завета даяния",
        "Господь ясно говорит: удержание десятины и приношений Он рассматривает как «обкрадывание» Бога. Напротив, принесение всей десятины в дом хранилища (дом Божий) — это шаг завета: мы доверяем Ему свои ресурсы, а Он обязуется открыть «отверстия небесные» и излить благословение до избытка, защитить плоды и сделать нас «землёю вожделенною».",
        "",
        "Как заключить завет даяния",
        "1. Обратитесь к Господу и покайтесь в том, что десятины и приношения не отдавались или отдавались не полностью.",
        "2. Решите в сердце отдавать десятину (десятую часть дохода) и приношения в дом Господень — туда, где вы духовно питаетесь и служите.",
        "3. В молитве заключите с Богом завет даяния: объявите Ему о своём решении и попросите силы и радости исполнять его.",
        "4. «Испытайте» Господа в этом: начните приносить десятину и приношения и доверьте Ему результат — Он обещает открыть небеса и благословить.",
        "",
        "Бог — Бог заветов и очень любит отношения завета со Своими детьми. Завет даяния — не «налог», а акт доверия и послушания, на который Он отвечает щедрым благословением.",
    ],
}

def main():
    os.makedirs(OUT_DIR, exist_ok=True)
    with zipfile.ZipFile(HERITAGE, "r") as z:
        for name in z.namelist():
            if name == "word/document.xml":
                continue
            # we'll add document.xml ourselves per file
            pass

    for filename, paragraphs in CONTENT.items():
        doc_xml = make_document_xml(paragraphs)
        out_path = os.path.join(OUT_DIR, filename)
        with zipfile.ZipFile(HERITAGE, "r") as z_in:
            with zipfile.ZipFile(out_path, "w", zipfile.ZIP_DEFLATED) as z_out:
                for item in z_in.namelist():
                    if item == "word/document.xml":
                        z_out.writestr(item, doc_xml)
                    else:
                        z_out.writestr(item, z_in.read(item))
        print("Создан:", os.path.join("Завет", filename))
    print("Готово. Файлы в папке:", OUT_DIR)

if __name__ == "__main__":
    main()
