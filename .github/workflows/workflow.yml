# .github/workflows/deploy.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
    tags: ['v*']
  pull_request:
    branches: [main, master]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  VERSION: ${{ github.sha }}

jobs:
  # ========== ТЕСТИРОВАНИЕ ==========
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: ['3.11']
        node: ['18']

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements*.txt'

      - name: Install Python deps
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-django pytest-cov

      - name: Run Django tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          SECRET_KEY: ${{ secrets.SECRET_KEY || 'test-secret-key' }}
          DEBUG: 'True'
          ALLOWED_HOSTS: localhost,127.0.0.1
        run: |
          cd backend
          python manage.py check --deploy
          python manage.py test --noinput --parallel
          pytest --cov=. --cov-report=xml

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install Node.js deps
        run: |
          cd frontend
          npm ci

      - name: Run frontend tests
        run: |
          cd frontend
          npm run build --if-present
          npm test --if-present --passWithNoTests

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            backend/coverage.xml
            backend/test-reports/

  # ========== СБОРКА И ПУШ В GHCR ==========
  build-and-push:
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-,format=short
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      # ===== Backend image =====
      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}-backend
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            ENVIRONMENT=production

      # ===== Frontend image =====
      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}-frontend
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            REACT_APP_API_URL=https://${{ vars.DOMAIN }}/api

      # ===== Cleanup old images =====
      - name: Cleanup old images
        uses: actions/github-script@v7
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          REGISTRY: ${{ env.REGISTRY }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        with:
          script: |
            const { OWNER, REPO, REGISTRY } = process.env;
            const { data: packages } = await github.rest.packages.getAllPackageVersionsForPackageOwnedByOrg({
              org: OWNER,
              package_type: 'container',
              package_name: REPO
            });

            const twoWeeksAgo = new Date();
            twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);

            for (const pkg of packages) {
              if (new Date(pkg.created_at) < twoWeeksAgo && pkg.metadata.container.tags.length === 0) {
                console.log(`Deleting old package: ${pkg.id}`);
                await github.rest.packages.deletePackageVersionForOrg({
                  org: OWNER,
                  package_type: 'container',
                  package_name: REPO,
                  package_version_id: pkg.id
                });
              }
            }

  # ========== ДЕПЛОЙ НА VPS ==========
  deploy:
    needs: build-and-push
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
          ssh-passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          DEPLOY_PATH: /opt/${{ github.event.repository.name }}
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Создаем скрипт деплоя
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "=== Начинаем деплой ==="
          cd $DEPLOY_PATH
          
          # Pull latest code
          git fetch origin
          git reset --hard origin/main
          
          # Create .env if not exists
          if [ ! -f .env ]; then
            cp .env.example .env
            echo "WARNING: .env создан из примера. Отредактируйте его!"
          fi
          
          # Login to GHCR
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Pull latest images
          docker compose -f docker-compose.prod.yml pull
          
          # Stop and remove old containers
          docker compose -f docker-compose.prod.yml down
          
          # Start new containers
          docker compose -f docker-compose.prod.yml up -d
          
          # Run migrations
          docker compose -f docker-compose.prod.yml exec -T backend python manage.py migrate --noinput
          
          # Collect static
          docker compose -f docker-compose.prod.yml exec -T backend python manage.py collectstatic --noinput --clear
          
          # Cleanup
          docker system prune -f --volumes
          
          echo "=== Деплой завершен ==="
          EOF
          
          chmod +x deploy.sh
          
          # Copy to VPS and execute
          scp -o StrictHostKeyChecking=no deploy.sh $VPS_USER@$VPS_HOST:$DEPLOY_PATH/
          ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST "cd $DEPLOY_PATH && bash deploy.sh"

      - name: Health check
        run: |
          sleep 30  # Wait for services to start
          curl -f https://${{ vars.DOMAIN }}/api/health/ || curl -f http://${{ secrets.VPS_HOST }}:80/api/health/ || true

      - name: Notify Telegram
        if: always()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d parse_mode=Markdown \
            -d text="*${{ github.repository }}*%0A${{ github.event.head_commit.message }}%0AStatus: ${{ job.status }}%0ABranch: ${{ github.ref }}%0A[View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

  # ========== РЕЛИЗ ТЕГА ==========
  release:
    needs: deploy
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## Changes
            ${{ github.event.head_commit.message }}
            
            ## Docker Images
            - Backend: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}-backend`
            - Frontend: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}-frontend`
            
            ## Deployment
            - Environment: Production
            - Domain: https://${{ vars.DOMAIN }}
            - Status: ✅ Deployed
          draft: false
          prerelease: false
          generate_release_notes: true
